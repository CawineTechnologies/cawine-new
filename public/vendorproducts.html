<!DOCTYPE html>
<html>

<head>
    <title>Cawine | Products</title>
    <link rel="icon" type="image/x-icon" href="images/cawine_main_icon_round.png">
    <meta name="viewport" content="width=device-width,  initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/tm_styles.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-storage.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body style="margin: 0%; padding: 0%;">
    <div id="loading-bar">
        <img style="width: 80px; height: 70px;" src="images/giphy.webp" />
    </div>
    <img id="poster-vendor" />
    <div id="vendor-products-view">
        <header>
            <h2 id="vendor-title">cawine</h2>
            <div class="shopping">
                <img src="images/shopping.svg">
                <span class="quantity">0</span>
            </div>
            <div id="close">
                <li style="margin-top: 12px;" class="fa fa-arrow-left"></li>
            </div>
        </header>
        <div id="wrapper-vendor-product">
            <div id="inner-container-view-vendor">
                <div id="product-list-vendor">

                </div>
            </div>
        </div>
        <!-- footer vendor -->
        <div id="show-cart-btn">
            <p id="btn-cart-qty">ORDER 0 FOR UGX<strong id="btn-cart-price">0.00</strong></p>
        </div>
        <!-- cart -->
        <div class="card">
            <div id="cart-list-view">
                <!-- <div id="cart-item-row">
                    <img id="cart-img-row" src="images/1.PNG" />
                    <p id="cart-name-row">Item name of cawin liquour 1ltr</p>
                    <p id="cart-price-row">UGX<strong>0.00</strong></p>

                    <div id="cart-btn-container">
                        <li id="cart-minus-btn" class="fa fa-minus"></li>
                        <p id="cart-qty-row">0</p>
                        <li id="cart-plus-btn" class="fa fa-plus"></li>
                    </div>
                </div> -->
            </div>
            <div
                style="position: absolute; top: 0%; width: 100%; height: 123px; background-color: white; box-shadow: 0 14px 28px rgba(153, 153, 153, 0.22), 0 1px 1px rgba(153, 153, 153, 0.22);">
            </div>
            <li id="cart-close-btn" class="fa fa-close"></li>
            <span id="cart-vendor-name">Cawine</span>
            <span style="position: absolute; left: 20px; top: 4rem; font-weight: bolder; font-size: 20px;">My
                Order</span>
            <span id="cart-selected-qty">0 items selected - cawine</span>
            <!-- <h1 style="color: limegreen;">My Order</h1>
            <div class="close-cart">
                <li style="margin-top: 6px;" class="fa fa-close"></li>
            </div>
            <ul class="listCard">
            </ul> -->
            <!-- <p id="proceed-to-cart-btm">PROCEED TO CHECKOUT</p> -->
            <!-- <div class="checkOut">
                <div class="total">0</div>
                <div class="closeShopping">Place order</div>
            </div> -->
        </div>
        <!-- checkout -->
        <!-- <div class="checkout">
            <div style="top: 0%; width: 100%; position: fixed; background-color: white;">
                <h3 style="color: limegreen; position: absolute; margin-left: 2rem;">Delivery details</h3>
                <div class="close-check-out">
                    <li style="margin-top: 6px;" class="fa fa-close"></li>
                </div>
            </div>
            <div style="width: 100%; height: auto; position: absolute; top: 12%;">
                <div style="width: 100%; height: 80px; position: relative;">
                    <span style="font-size: 13px; color: #777; position: absolute; left: 2rem;">Deliver to</span>
                    <p id="deliver-to">Loading ....</p>
                </div>
                <div style="width: 100%; height: 80px; position: relative;">
                    <span style="font-size: 13px; color: #777; position: absolute; left: 2rem;">Phonber number</span>
                    <p id="phone-no">+256712345678</p>
                </div>
                <div style="width: 100%; height: 80px; position: relative;">
                    <span style="font-size: 13px; color: #777; position: absolute; left: 2rem;">Delivery notes</span>
                    <input id="order-notes" placeholder="E.g opposite suppermarket" />
                </div>
                <div style="width: 100%; height: 80px; position: relative;">
                    <span style="font-size: 13px; color: #777; position: absolute; left: 2rem;">Payment method</span>
                    <p style="font-size: 16px; color: #000; position: absolute; top: 0.5rem; left: 2rem;">Cash on
                        delivery</p>
                </div>
            </div>
            <div
                style="width: 100%; height: 200px; position: absolute; bottom: 0%; background-color: rgb(214, 243, 243);">
                <h2 style="font-size: 16px; color: #000; position: absolute; margin-top: 10px; left: 2rem;">Summary</h2>
                <p style="font-size: 16px; color: #000; position: absolute; top: 1.2rem; left: 2rem;">Total</p>
                <p id="total-currency">UGX<strong id="total">0</strong></p>
                <p style="font-size: 16px; color: #000; position: absolute; top: 3rem; left: 2rem;">Delivery fee</p>
                <p id="delivery-fee-currency">UGX<strong id="delivery-fee">5000</strong></p>
                <p style="font-size: 16px; color: #000; position: absolute; top: 5rem; left: 2rem;">Sub total</p>
                <p id="sub-total-currency">UGX<strong id="sub-total">0</strong></p>
                <div id="place-order-btn">
                    <strong id="cancel-status-btn">Place order</strong>
                </div>
            </div>
        </div> -->
        <!-- order-payment-dlg -->
        <div class="order-payment-dlg">
            <div class="payment-dlg">
                <h2 style="color: limegreen; position: relative; margin-left: 1rem;">Order delivered successufully</h2>
                <p id="amount-title">Amount to
                    pay</p>
                <p id="amount-to-pay">UGX<strong id="order-payment-amount">0</strong></p>
                <div id="order-payment-btn">
                    <span id="cancel-status-btn">Thank you</span>
                </div>
            </div>
        </div>

        <!-- order-warn-dlg -->
        <div class="order-warn-dlg">
            <div class="dialog">
                <span style="margin-top: 2.2rem; margin-left: 1rem; margin-right: 4rem; position: absolute;">Once order
                    is placed, can not be cancelled! </br>Proceed to chekout?</span>
                <div
                    style="position: absolute; width: 100%; height: 20%; border-radius: 0px 0px 10px 10px; display: flex; bottom: 0%; background-color: rgb(14, 13, 13);">
                    <div id="cancel-order-dlg-btn">
                        <span style="color: white; position: absolute; top: 0.6rem; left: 7rem;">Cancel</span>
                    </div>
                    <div style="display: inline-block; height: 100%; width: 2px; background-color: rgb(136, 133, 133);">
                    </div>
                    <div id="proceed-dlg-btn">
                        <span
                            style="color: white; position: absolute; top: 0.6rem; right: 7rem; color: limegreen;">Proceed</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
    <script src="js/index.js"></script>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDocs, collection, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let cart = [];
        var userId = "";
        var vendorID = "";
        var userName = "";
        var vendorItem = "";
        var vendorName = "";
        var currency = "";
        var subTotal = 0;
        var productVendor = "";
        let status = "";
        let phoneNumber = "";
        let displayName = "";
        let openShopping = document.querySelector('.shopping');
        let closeShopping = document.querySelector('.close-cart');
        let openCheckOut = document.querySelector('.closeShopping');
        let closeCheckOut = document.querySelector('.close-check-out');
        let list = document.querySelector('.list');
        let listCard = document.querySelector('.listCard');
        let body = document.querySelector('body');
        let total = document.querySelector('.total');
        let quantity = document.querySelector('.quantity');

        let products = [];
        let count = 0;
        var totalPrice = 0;
        var cartItemRow = "";

        document.getElementById('close').addEventListener('click', (e) => {
            let bundle = localStorage.getItem("bundle");
            if (bundle == "offers") {
                window.location.href = "offers.html";
            } else if (bundle == "eats") {
                window.location.href = "eats.html";
            } else if (bundle == "drinks") {
                window.location.href = "drinks.html";
            } else {
                window.location.href = "home.html";
            }
        });

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                userId = user.uid;
                console.log(userId);
                vendorID = localStorage.getItem('vendor_id');
                getUserInfo(userId, vendorID);
                getVendorProducts(vendorID);
            }
        });

        async function getVendorProducts(vendorUid) {
            const vendorRef = doc(db, "Vendors", vendorUid);
            const vendorUidData = await getDoc(vendorRef);
            if (vendorUidData.exists()) {
                currency = vendorUidData.data().currency;
                vendorName = vendorUidData.data().name;
                status = vendorUidData.data().status;
                reloadCard(userId, vendorUidData.data().vendorID);
                document.getElementById('poster-vendor').src = vendorUidData.data().poster;
                document.getElementById('vendor-title').innerHTML = vendorUidData.data().name;
                document.getElementById('cart-vendor-name').innerHTML = vendorUidData.data().name;

                loadProducts(vendorUidData.data().vendorID);
            }
        }

        async function loadProducts(vendor) {
            let vendorId = localStorage.getItem("vendor_id");
            const querySnapshot = await getDocs(collection(db, "Products"));
            querySnapshot.forEach((doc) => {
                var vUid = doc.data().vendorID;
                if (vUid == vendorId) {
                    let db = firebase.firestore();
                    db.collection("Cart").doc(userId).collection("Items").doc(doc.data().name).get().then(function (it) {
                        if (it.data() != null) {
                            productVendor += "<div id='item-vendor-product'>";
                            productVendor += "<img id='item-img-vendor-product' src='" + doc.data().poster + "'/>";
                            productVendor += "<p id='item-name-vendor-product'>" + doc.data().name + "</p>";
                            productVendor += "<p id='item-qty-vendor-product'>" + doc.data().qty + "</p>";
                            productVendor += "<p id='item-price-vendor-product'>UGX<strong>" + parseInt(doc.data().price).toLocaleString() + "</strong></p>";
                            productVendor += "<span id='item-add-to-cart-btn' class='material-icons'>check</span>";
                            productVendor += "<span id='vendor-uid-prod'>" + doc.data().name + "</span>";
                            productVendor += "</div>";

                            document.getElementById('product-list-vendor').innerHTML = productVendor;

                            var uidItem = document.querySelectorAll("#item-vendor-product span");
                            for (var i = 0; i < uidItem.length; i++) {
                                uidItem[i].onclick = function () {
                                    if (status === "Offline") {
                                        alert("This vendor is not delivering for now.\nPlease try again later");
                                    } else {
                                        if (displayName != "" && phoneNumber != "") {
                                            var uid = this.innerHTML;
                                            localStorage.setItem("name", uid);
                                            localStorage.setItem("bundle", "products");
                                            window.location.href = "addtocart.html";
                                        } else {
                                            window.location.href = "completeregistration.html";
                                        }
                                    }
                                    // getVendorProdInfo(uid);
                                }
                            }

                        } else {
                            productVendor += "<div id='item-vendor-product'>";
                            productVendor += "<img id='item-img-vendor-product' src='" + doc.data().poster + "'/>";
                            productVendor += "<p id='item-name-vendor-product'>" + doc.data().name + "</p>";
                            productVendor += "<p id='item-qty-vendor-product'>" + doc.data().qty + "</p>";
                            productVendor += "<p id='item-price-vendor-product'>UGX<strong>" + parseInt(doc.data().price).toLocaleString() + "</strong></p>";
                            productVendor += "<span id='item-add-to-cart-btn'>+</span>";
                            productVendor += "<span id='vendor-uid-prod'>" + doc.data().name + "</span>";
                            productVendor += "</div>";

                            document.getElementById('product-list-vendor').innerHTML = productVendor;

                            var uidItem = document.querySelectorAll("#item-vendor-product span");
                            for (var i = 0; i < uidItem.length; i++) {
                                uidItem[i].onclick = function () {
                                    if (status === "Offline") {
                                        alert("This vendor is not delivering for now.\nPlease try again later");
                                    } else {
                                        if (displayName != "" && phoneNumber != "") {
                                            var uid = this.innerHTML;
                                            localStorage.setItem("name", uid);
                                            localStorage.setItem("bundle", "products");
                                            window.location.href = "addtocart.html";
                                        } else {
                                            window.location.href = "completeregistration.html";
                                        }
                                    }
                                    // getVendorProdInfo(uid);
                                }
                            }
                        }
                    });

                }
            });

            var loadingBar = document.getElementById('loading-bar');
            loadingBar.style.display = "none";

            var dlg = document.getElementById("vendor-products-view");
            dlg.style.display = "block";
        }

        document.getElementById('cart-close-btn').addEventListener('click', () => {
            body.classList.remove('active');
        });

        async function reloadCard(userId, vendorid) {
            console.log(userId + " and " + vendorid)
            // let listCard = document.getElementById('cart-list-view').innerHTML = '';
            const querySnapshot = await getDocs(collection(db, "Cart", userId, "Items"));
            querySnapshot.forEach((doc) => {
                var vUid = doc.data().vendorID;
                if (doc.data() != null && vendorid == vUid) {
                    products = doc;
                    totalPrice += parseInt(doc.data().orderPrice);
                    count += parseInt(doc.data().itemCount);
                    document.getElementById('cart-selected-qty').innerHTML = count + " items selected - cawine";
                    var showCartBtn = document.getElementById('show-cart-btn');
                    showCartBtn.style.display = "flex";

                    cartItemRow += `<div id="cart-item-row">
                       <img id="cart-img-row" src="${doc.data().poster}"/>
                       <p id="cart-name-row">${doc.data().name}</p>
                       <p id="cart-price-row">UGX<strong>${parseInt(doc.data().orderPrice).toLocaleString()}</strong></p>
                       <div id="cart-btn-container">
                          <li id="cart-minus-btn" class="fa fa-minus" onclick="changeQuantity(${doc.id}, ${count - 1})"></li>
                          <p id="cart-qty-row">${parseInt(doc.data().itemCount)}</p>
                          <li id="cart-plus-btn" class="fa fa-plus" onclick="changeQuantity(${doc.id}, ${count + 1})"></li>
                        </div>
                        <span id="cart-sel-item-btn">${doc.data().vendorID}</span>
                    </div>`;
                }
                // var listVendors = document.getElementById('product-list-vendor');
                // listVendors.style.bottom = "3rem";
            });
            document.getElementById('cart-list-view').innerHTML = cartItemRow;

            var qty = "ORDER " + count + " FOR UGX";
            console.log(qty);
            document.getElementById('btn-cart-qty').innerHTML = qty + "<strong>" + totalPrice.toLocaleString() + "</strong>";

            document.getElementById('show-cart-btn').addEventListener('click', (e) => {
                checkOrder();
            });

            document.getElementById('proceed-to-cart-btm')
                .addEventListener('click', (e) => {
                    body.classList.remove('active');
                    body.classList.add('open');
                });
        }

        async function changeQuantity(key, quantity) {

            if (quantity == 0) {
                return;
            } else {
                var map = {
                    itemCount: quantity
                }
                var db = firebase.firestore();
                db.collection("Cart").doc(userId).collection("Items")
                    .doc(products[key].data().name).update(map).then((e) => {
                        reloadCard(userId, products[key].data().vendorID);
                    });
            }
            // reloadCard();
        }

        async function getUserInfo(currentUser, currenrVendor) {
            const userRef = doc(db, "Users", currentUser);
            const userData = await getDoc(userRef);
            if (userData.exists()) {
                if (userData.data().displayName != null) {
                    displayName = userData.data().displayName;
                }
                if (userData.data().phoneNumber != null) {
                    phoneNumber = userData.data().phoneNumber;
                }
                console.log(displayName + " and " + phoneNumber)
                loadOrderPricing(userData.data().userID, currenrVendor);
            }
        }

        async function loadOrderPricing(cUser, cVendor) {
            let count = 0;
            var totalPrice = 0;
            var allDocData;
            const querySnapshot = await getDocs(collection(db, "Cart", cUser, "Items"));
            querySnapshot.forEach((doc) => {
                var vUid = doc.data().vendorID;
                if (cVendor == vUid) {
                    count += parseInt(doc.data().itemCount);
                    allDocData = doc;
                    totalPrice += parseInt(doc.data().orderPrice);
                    subTotal = parseInt(totalPrice) + 5000;
                }
            });
            // checkOrder();
            quantity.innerHTML = count;
            quantity.addEventListener('click', (e) => {
                checkOrder();
            });
            // document.getElementById('total').innerHTML = totalPrice.toLocaleString();
            // document.getElementById('sub-total').innerHTML = subTotal.toLocaleString();

            document.getElementById('place-order-btn').addEventListener('click', (evn) => {
                body.classList.remove('open');
                body.classList.add('warn');
            });

            document.getElementById('proceed-dlg-btn').addEventListener('click', (evn) => {
                var d = new Date()
                var month = String(d.getMonth() + 1).padStart(2, '0');
                var date = d.getDate() + " " + month + " " + d.getFullYear();
                var time = moment().format('hh:mm');
                var deliverTo = document.getElementById('deliver-to').innerHTML;
                var phoneNumber = document.getElementById('phone-no').innerHTML;
                var deliveryNotes = document.getElementById('order-notes').value;
                var map = {
                    dest: deliverTo,
                    phone: phoneNumber,
                    vendorTitle: vendorName,
                    orderTime: "Placed at: " + time,
                    orderDate: date,
                    vendorID: vendorID,
                    client: userId,
                    name: userName,
                    order: "pending",
                    price: "" + subTotal,
                    deliveryFee: "5000",
                    paymentType: "Cash",
                    currency: currency,
                    deliveryNotes: deliveryNotes
                }
                var db = firebase.firestore();
                db.collection("New orders").doc(userId).set(map);
                // window.alert(`Deliver to: ${place.name}, ${address}`);
                body.classList.remove('warn');
                body.classList.add('status');
            });

            document.getElementById('cancel-order-dlg-btn').addEventListener('click', (evn) => {
                body.classList.remove('warn');
            });

            document.getElementById('cancel-order-btn').addEventListener('click', (evn) => {
                body.classList.remove('status');
            });
        }

        async function checkOrder() {
            const userRef = doc(db, "New orders", userId);
            const userData = await getDoc(userRef);
            if (userData.exists()) {
                var order = userData.data().order;
                if (order == "preparing") {

                    body.classList.add('status');
                    document.getElementById('prepare-order-dot').style.backgroundColor = "limegreen";
                    document.getElementById('prepare-order-text').style.color = "limegreen";
                    document.getElementById('prepare-order-line').style.backgroundColor = "limegreen";
                    document.getElementById('cancel-order-btn').style.display = "none";
                } else if (order == "delivering") {
                    body.classList.add('status');
                    document.getElementById('prepare-order-dot').style.backgroundColor = "limegreen";
                    document.getElementById('prepare-order-text').style.color = "limegreen";
                    document.getElementById('prepare-order-line').style.backgroundColor = "limegreen";
                    document.getElementById('oredr-in-transit-dot').style.backgroundColor = "limegreen";
                    document.getElementById('order-in-transit-text').style.color = "limegreen";
                    document.getElementById('cancel-order-btn').style.display = "none";
                } else if (order == "received") {
                    document.getElementById('order-payment-amount').innerHTML = subTotal.toLocaleString();
                    body.classList.add('payment');
                    document.getElementById('order-payment-btn').addEventListener('click', (evn) => {
                        var map = {
                            order: "completed"
                        }
                        var db = firebase.firestore();
                        db.collection("New orders").doc(userId).update(map).then(function (e) {
                            window.alert('Order completed');
                            window.location.assign("home.html");
                        });
                    });
                } else {
                    localStorage.setItem("vendor_id", vendorID);
                    window.location.assign("cart.html");
                }
            } else {
                localStorage.setItem("vendor_id", vendorID);
                window.location.assign("cart.html");
            }
        }

        closeCheckOut.addEventListener('click', () => {
            body.classList.remove('open');
        });

        openCheckOut.addEventListener('click', () => {
            body.classList.remove('active');
            body.classList.add('open');
        });
    </script>
    <script>
        
        let newCart = [];
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                let userId = user.uid;
                let vendorID = localStorage.getItem('vendor_id');
                loadCart(userId, vendorID);
            }
        });
        const loadCart = (uid, vUid) => {
            let db = firebase.firestore();
            db.collection("Cart").doc(uid).collection("Items").get().then(function (snapshot) {
                snapshot.forEach((it) => {
                    if (it.data().vendorID === vUid) {
                        newCart.push({
                            name: it.data().name,
                            count: parseInt(it.data().itemCount),
                            price: parseInt(it.data().price)
                        })
                    }
                })
                console.log(newCart);
                addCartToMemory();
            });
        }

        const addCartToMemory = () => {
            localStorage.setItem('cart', JSON.stringify(newCart));
        }
    </script>
</body>

</html>
