<!DOCTYPE html>
<html>

<Head>
    <title>Complete registraion</title>
    <link rel="icon" type="image/x-icon" href="./images/cawine_main_icon_round.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,  initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/tm_styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</Head>

<body
    style="width: auto; height: 100vh; margin: 0%; padding: 0%; height: 0%;  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;">
    <div id="prof-holder">
        <div style="width: 100%; height: 100%; position: relative; top: 4rem;">
            <strong style="position: relative; top: 1rem; left: 1rem; font-size: large;">One more step</strong>
            <p style="position: relative; left: 1rem; top: 0.2rem;">You are almost there</p>
            <p style="position: relative; margin-left: 1rem; margin-right: 1rem; font-size: 15px;">Enter your
                first name, last name and phone number to continue</p>
            <p style="position: relative; margin-top: 1.5rem; margin-left: 1.5rem;">First name*</p>
            <div
                style=" margin-left: 1.5rem; margin-right: 1.5rem; display: flex; align-items: center; justify-content: center;">
                <input type="text" id="f-name" placeholder="Enter first name" required="username" />
            </div>

            <p style="position: relative; margin-top: 1.5rem; margin-left: 1.5rem;">Last name*</p>
            <div
                style=" margin-left: 1.5rem; margin-right: 1.5rem; display: flex; align-items: center; justify-content: center;">
                <input type="username" id="l-name" placeholder="Enter last name" required="username" />
            </div>

            <p style="position: relative; margin-top: 1.5rem; margin-left: 1.5rem;">Phone number*</p>
            <div
                style=" margin-left: 1.5rem; margin-right: 1.5rem; display: flex; align-items: center; justify-content: center;">
                <input type="phone" id="user-phone" placeholder="Enter phone number" required="phone" />
            </div>

            <p style="position: relative; margin-top: 2rem; margin-left: 1.5rem;">Enter promo code if you have one to
                earn 5% OFF your first two orders</p>
            <div
                style=" margin-left: 1.5rem; margin-right: 1.5rem; display: flex; align-items: center; justify-content: center;">
                <input type="text" id="user-code" placeholder="Enter referral code (optional)" />
            </div>

            <p style="position: relative; margin-top: 3rem; margin-left: 1.5rem;">Profile picture</p>
            <div style="width: 100%; position: relative; display: flex; align-items: center; justify-content: center;">
                <img id="prof-pic-img" src="images/profile_pic.png" />
            </div>

            <div id="sel-img-btn">
                <p style="font-size: 17px; color: white;">SELECT IMAGE</p>
            </div>
            <input type="file" id="input-img-uri" />

            <div style="width: 100%; height: 150px;"></div>
        </div>
        <div id="prof-nav">
            <h2 style="position: absolute; left: 20px;">Profile</h2>
            <!-- <div id="close-profile-btn">
                <li class="fa fa-close"></li>
            </div> -->
        </div>

        <div id="save-profile-btn">
            <span style="color: white;">SUBMIT</span>
        </div>
    </div>

    <div id="loading">
        <img src="images/loading.gif" width="70px" height="70px">
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <script src="js/index.js"></script>
    <script>
        let selectedImgUri;
        let imgdownloadUrl;

        $('#sel-img-btn').click(function () {
            $('#input-img-uri').trigger('click');
        });

        $("#input-img-uri").on("change", function (event) {
            if (!(/\.(png|jpg|jpeg)$/i).test(event.target.files[0].name)) {
                window.alert('File not suppoted, upload png, jpg or jpeg files only!');
                return;
            }
            var db = firebase.firestore();
            selectedImgUri = event.target.files[0];
            let fileName = selectedImgUri.name;
            firebase.auth().onAuthStateChanged(function (user) {
                var userId = user.uid;
                let storageRef = firebase.storage().ref("Users/" + userId + fileName);
                let uploadTask = storageRef.put(selectedImgUri);
                uploadTask.on("state_changed", (snapshot) => {
                    console.log(snapshot);
                    percentageVal = Math.floor((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                    console.log(percentageVal);
                    console.log(userId);
                }, (error) => {
                    console.log("Error is: " + error);
                }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        console.log("ImageLink: " + url);
                        imgdownloadUrl = url;
                        var map = {
                            profilePic: imgdownloadUrl
                        }
                        db.collection("Users").doc(userId).update(map).then(function (e) {
                            document.getElementById('prof-pic-img').src = url;
                        });
                    });
                });
            });
        });

        document.getElementById('close-profile-btn').addEventListener('click', (e) => {
            window.location.href = "home.html";
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { createUserWithEmailAndPassword, getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        var firebaseConfig = {
            apiKey: "AIzaSyByGzJ_xF3kMCK1JQvEUWvJeBaB-NQkmno",
            authDomain: "cawine-736ac.firebaseapp.com",
            databaseURL: "https://cawine-736ac-default-rtdb.firebaseio.com",
            projectId: "cawine-736ac",
            storageBucket: "cawine-736ac.appspot.com",
            messagingSenderId: "643248682742",
            appId: "1:643248682742:web:c2ae192bf3cfbfe818ded7",
            measurementId: "G-2HEXE80L51"
        };

        var db = firebase.firestore();

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                var userId = user.uid;
                console.log(userId);
                db.collection("Users").doc(userId).get().then((it) => {
                    if (it.data() != null && it.data().displayName != null) {
                        if (it.data().fName != null) {
                            var fName = it.data().fName;
                            var lName = it.data().lName;
                            document.getElementById('f-name').value = fName;
                            document.getElementById('l-name').value = lName;
                        }
                        if (it.data().phoneNumber) {
                            var phoneNumber = it.data().phoneNumber;
                            var fullPhoneNumber = phoneNumber;
                            document.getElementById('user-phone').value = fullPhoneNumber;
                        }
                        if (it.data().profilePic != null) {
                            document.getElementById('prof-pic-img').src = it.data().profilePic;
                            if (imgdownloadUrl == null) {
                                imgdownloadUrl = it.data().profilePic;
                            }
                        }
                        document.getElementById('loading').style.display = "none";
                    } else {
                        document.getElementById('loading').style.display = "none";
                    }
                });
            }
        });

        document.getElementById('save-profile-btn').addEventListener('click', function (evt) {

            var fName = document.getElementById('f-name').value;
            var lName = document.getElementById('l-name').value;
            var phoneNumber = document.getElementById('user-phone').value;

            if (fName != "" && lName != "" && phoneNumber != "") {
                document.getElementById('loading').style.display = "flex";
                firebase.auth().onAuthStateChanged(function (user) {
                    var userId = user.uid;
                    var map = {
                        fName: fName,
                        lName: lName,
                        phoneNumber: phoneNumber,
                        displayName: `${fName} ${lName}`
                    }
                    db.collection("Users").doc(userId).update(map).then(function (e) {
                        let promo_code = document.getElementById('user-code').value;

                        if (promo_code != "") {
                            console.log(promo_code);
                            db.collection("Referrals").get().then(function (snapshot) {
                                snapshot.forEach((it) => {
                                    
                                    let promoRef = it.data().referralCode;
                                    let status = it.data().status;
                                    // console.log(promo_code);
                                    if (userId != it.data().vendorID && promo_code == promoRef) {
                                        console.log(promoRef);
                                        let reward = it.data().reward + 200;
                                        let map = {
                                            reward: reward,
                                        }
                                        db.collection("Referrals").doc(it.data().vendorID)
                                            .update(map).then(function (e) {
                                                var map = {
                                                    nfName: fName,
                                                    lName: lName,
                                                    phoneNumber: phoneNumber,
                                                    displayName: `${fName} ${lName}`,
                                                    userID: userId,
                                                }
                                                db.collection("Referrals").doc(it.data().vendorID).collection('Clients')
                                                    .doc(userId).set(map).then(function () {
                                                        document.getElementById('loading').style.display = "none";
                                                        window.alert('Profile updated');
                                                        console.log(userId);
                                                        window.location.href = "home.html";
                                                    });
                                            });
                                    }
                                });
                            });
                        } else {
                            document.getElementById('loading').style.display = "none";
                            window.alert('Profile updated');
                            console.log(userId);
                            window.location.href = "home.html";
                        }

                    })
                });
            } else {
                window.alert("Please fill all required fields!");
            }
        });

    </script>
</body>

</html>