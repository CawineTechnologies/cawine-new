<!DOCTYPE html>
<html>

<head>
    <title>Cawine | Order history</title>
    <link rel="icon" type="image/x-icon" href="images/cawine_main_icon_round.png">
    <meta name="viewport" content="width=device-width,  initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/tm_styles.css">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body style="background-color: white;">
    <div id="loading-bar">
        <img style="width: 80px; height: 70px;" src="images/giphy.webp" />
    </div>
    <div style="position: fixed; height: 60px; width: 100%; top: 0%;">
        <span style="position: fixed; left: 2rem; top: 0.8rem; font-size: 24px; font-weight: 700;">Order History</span>
        <div id="menu-close-btn">
            <li class="fa fa-close"></li>
        </div>
        <div id="order-history-view">
            <!-- <div id="order-history-list-row">
                <img id="order-hitory-pic" src="images/1.PNG" />
                <li id="order-history-name">Loading ...</li>
                <li id="order-history-qty">Loading ...</li>
                <li id="order-history-price">Loading ...</li>
                <li id="order-history-desc">Loading ...</li>
                <li id="order-history-vendor">Loading ...</li>
                <li id="order-history-date">Loading ...</li>
            </div> -->
        </div>
        
    </div>
    <script src="js/index.js"></script>
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDocs, collection, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByGzJ_xF3kMCK1JQvEUWvJeBaB-NQkmno",
            authDomain: "cawine-736ac.firebaseapp.com",
            databaseURL: "https://cawine-736ac-default-rtdb.firebaseio.com",
            projectId: "cawine-736ac",
            storageBucket: "cawine-736ac.appspot.com",
            messagingSenderId: "643248682742",
            appId: "1:643248682742:web:c2ae192bf3cfbfe818ded7",
            measurementId: "G-2HEXE80L51"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        var userId = "";
        var orderItem = "";
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                userId = user.uid;
                getUserData(userId);
            }
        });
        async function getUserData(userId) {
            const querySnapshot = await getDocs(collection(db, "Order History"));
                querySnapshot.forEach((doc) => {
                    var uid = doc.data().userID;
                    if(doc.data().userID == userId) {
                        console.log(uid);
                        orderItem += `<div id="order-history-list-row">
                            <img id="order-hitory-pic" src="${doc.data().poster}" />
                            <li id="order-history-name">${doc.data().name}</li>
                            <li id="order-history-qty">${doc.data().qty + " x " + doc.data().itemCount}</li>
                            <li id="order-history-price">${doc.data().currency + parseInt(doc.data().orderPrice).toLocaleString()}</li>
                            <li id="order-history-desc">${doc.data().desc}</li>
                            <li id="order-history-vendor">${(doc.data().vendorName != null ? doc.data().vendorName + " - Vendor" : "Vendor")}</li>
                            <li id="order-history-date">${doc.data().date + " - " + doc.data().time}</li>
                            </div>`;
                    }
                });
                document.getElementById('order-history-view').innerHTML = orderItem;
                document.getElementById('order-history-view').innerHTML += `<div style="width: 100%; height: 100px; position: relative;"></div>`;

                var loadingBar = document.getElementById('loading-bar');
                loadingBar.style.display = "none";
        }
        document.getElementById('menu-close-btn').addEventListener('click', (e) => {
            window.location.href = "home.html";
        });

        async function getVendorName(vendor) {
            const vendorRef = doc(db, "Vendors", vendor);
            const vendorData = await getDoc(vendorRef);
            if(vendorData.exists()) {
                let newDiv = document.getElementById('order-history-name');
                newDiv.id = "order-history-name";
                newDiv.innerHTML = vendorData.data().name;
                orderItem += newDiv;
            }
        }
    </script>
</body>

</html>
